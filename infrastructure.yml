---
AWSTemplateFormatVersion: "2010-09-09"
Description: ECS Infrastructure

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Default: vpc-a2418bc5

Resources:
  EC2IAMRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: '/'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2IAMRole

  LaunchConfiguration:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      IamInstanceProfile: !Ref EC2InstanceProfile
      ImageId: ami-05b48eda7f92aadbe
      InstanceType: t2.small
      KeyName: ecs-keypair
      UserData:
        Fn::Base64:
          Fn::Join: [
            "",
            [
              "#!/bin/bash -xe\n",
              "sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm"
            ]
          ]

  AutoScalingGroup:
    DependsOn:
      - LifecycleRole
      - ASGSNSTopic
      - ASGSNSTopicPolicy
      - LoadBalancer
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfiguration
      LoadBalancerNames:
        - !GetAtt LoadBalancer.LoadBalancerName
      MaxSize: '1'
      MinSize: '1'
      TargetGroupARNs:
        - !Ref TargetGroup

  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Subnets:
        - subnet-f2af3295
        - subnet-f451b6ac

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Port: 8000
      Protocol: TCP
      VpcId: !Ref VpcId

  LifecycleHook:
    Type: AWS::AutoScaling::LifecycleHook
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      DefaultResult: CONTINUE
      HeartbeatTimeout: 300
      LifecycleTransition: 'autoscaling:EC2_INSTANCE_LAUNCHING'
      NotificationTargetARN: !Ref ASGSNSTopic
      RoleARN: !GetAtt LifecycleRole.Arn

  LifecycleRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
            - 'sts:AssumeRole'
          Effect: Allow
          Principal:
            AWS: "*"
        Version: '2012-10-17'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AutoScalingNotificationAccessRole

  ASGSNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: ECS AutoScaling Group Topic
      TopicName: ECS_ASG_Topic

  ASGSNSTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      PolicyDocument:
        Id: ECS_ASG_Topic_Policy
        Version: '2012-10-17'
        Statement:
        - Sid: AllowLifecycleRole
          Effect: Allow
          Principal:
            AWS: "*"
          Action: sns:Publish
          Resource: "*"
      Topics:
      - !Ref ASGSNSTopic

  SSMMountDocument:
    Type: AWS::SSM::Document
    Properties:
      Content:
        schemaVersion: "2.2"
        description: "Command document for mounting the EBS volume"
        mainSteps:
        - action: "aws:runShellScript"
          name: "MountVolume"
          inputs:
            runCommand:
            - "mount /dev/xdvy /data"
      DocumentType: Command

Outputs:
  TopicArn:
    Export:
      Name: !Join ['-', [!Ref 'AWS::StackName', 'TopicArn']]
    Value: !Ref ASGSNSTopic

  DocumentName:
    Export:
      Name: !Join ['-', [!Ref 'AWS::StackName', 'Document']]
    Value: !Ref SSMMountDocument
