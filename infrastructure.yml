Resources:
  LaunchConfiguration:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      ImageId: ami-05b48eda7f92aadbe
      InstanceType: t3.small

  AutoScalingGroup:
    DependsOn:
      - LifecycleRole
      - ASGSNSTopic
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfiguration
      MaxSize: 1
      MinSize: 1
      # LifecycleHookSpecificationList:
      #   - LifecycleTransition: 'autoscaling:EC2_INSTANCE_LAUNCHING'
      #     LifecycleHookName: 'InstanceCreationLifeCycleHook'
      #     HeartbeatTimeout: 300
      #     NotificationTargetARN: !Ref ASGSNSTopic
      #     RoleARN: !GetAtt LifecycleRole.Arn

  LifecycleRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action: ['sts:AssumeRole']
          Effect: Allow
          Principal:
            Service: [cloudformation.amazonaws.com]
        Version: '2012-10-17'
      Path: /
      Policies:
        - PolicyName: CloudFormationRole
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Action: '*'
                Effect: Allow
                Resource: '*'

  ASGSNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: ECS AutoScaling Group Topic
      TopicName: ECS_ASG_Topic

  ASGSNSTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      PolicyDocument:
        Id: ECS_ASG_Topic_Policy
        Version: '2012-10-17'
        Statement:
        - Sid: AllowLifecycleRole
          Effect: Allow
          Principal:
            AWS: !GetAtt LifecycleRole.Arn
          Action: sns:Publish
          Resource: "*"
      Topics:
      - !Ref ASGSNSTopic
